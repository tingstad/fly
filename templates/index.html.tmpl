<!DOCTYPE html>
<html lang="en">
<head>
<title>Space invaders</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/5.5.0/xterm.js" integrity="sha512-Gujw5GajF5is3nMoGv9X+tCMqePLL/60qvAv1LofUZTV9jK8ENbM9L+maGmOsNzuZaiuyc/fpph1KT9uR5w3CQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/xterm/5.5.0/xterm.min.css" integrity="sha512-XpXUuzg5afNt1bsgnrOesXP70TLH8tXYYK5sK+Y0UV+YBvJn9EfRFYWy4HT3TVDfH0nl1CO0lwOxIrt2gk9qjg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
html, body {
    margin: 0;
    padding: 0;
}
.xterm-screen {
    margin: 0 auto; /* center horizontally */
}
#buttons {
    width: 864px;
    margin: 0 auto;
    display: flex;
}
button#space {
    flex-grow: 2;
}
button {
    padding: 8px 4px;
}
</style>
</head>
<body>
<div id="terminal"></div>
<div id="buttons">
<button id="left">&lt;= LEFT</button> <button id="space">SPACE</button> <button id="right">RIGHT =&gt;</button>
</div>
<script>
    var term = new Terminal({ fontSize: 18 });
    term.open(document.getElementById('terminal'));
    term.focus();
    term.write('Hello, \x1B[1;3;31World\x1B[0m! $ ')
    term.write('\x1B[?25l');
    let prot = location.protocol == "http:" ? "ws" : "wss";
    let ws = new WebSocket(prot + "://" + location.host + "/ws");
    ws.onopen = function(evt) {
        console.log("OPEN");
    };
    ws.onclose = function(evt) {
        console.log("CLOSE");
        term.write('\x1B[?25h');
    };
    ws.onmessage = function(evt) {
        term.write(evt.data);
    };
    ws.onerror = function(evt) {
        console.log("ERROR: " + evt.data);
    };
    term.onData(e => {
        ws.send(e);
    });
    const left  = () => ws.send({{ if .IsLinux }} "\x1b[D" {{else}} "\u001bOD" {{end}});
    const right = () => ws.send({{ if .IsLinux }} "\x1b[C" {{else}} "\u001bOC" {{end}});
    const space = () => ws.send(" ");
    let interval;
    document.getElementById('left').addEventListener("mousedown", function() {
        left();
        interval = setInterval(left, 100);
    });
    document.getElementById('right').addEventListener("mousedown", function() {
        right();
        interval = setInterval(right, 100);
    });
    document.getElementById('space').addEventListener("mousedown", function() {
        space();
        interval = setInterval(space, 100);
    });
    document.addEventListener("mouseup", () => clearInterval(interval));
    document.addEventListener("mouseleave", () => clearInterval(interval));
    document.addEventListener('keydown', function (event) {
        if (event.key === "ArrowLeft" || event.keyCode === 37) {
            event.preventDefault();
            left();
        } else if (event.key === "ArrowRight" || event.keyCode === 39) {
            event.preventDefault();
            right();
        } else if (event.key === " " || event.keyCode === 32) {
            event.preventDefault();
            space();
        } else {
            return;
        }
        term.focus();
    });
</script>
</body>
</html>
